<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Large File Download</title>

  <style>
    progress {
      width: 320px;
      height: 22px;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <h1>Large File Download</h1>

  <button class="downloadBtn" file="file1Url">Start Download</button>
  <button class="downloadBtn" file="file2Url">Start Download</button>

  <br><br>
  <progress id="progressBar" value="0" max="100"></progress>
  <p id="status"></p>

  <button id="messageBtn">Message Btn</button>
  <br><br>

  <a href="/download">BackGround fetch page</a>

  <script>
    const messageBtn = document.getElementById("messageBtn");
    const downloadBtns = document.querySelectorAll(".downloadBtn"); // Updated to select by class
    const progressBar = document.getElementById("progressBar");
    const statusText = document.getElementById("status");

    window.file1Url = "http://localhost:3000/images/test.mp4";
    window.file2Url = "http://localhost:3000/images/stream-folder";
    let isDownloading = false;

    // 1. Unified Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        // Register the unified SW
        navigator.serviceWorker.register('/sw.js')
          .then(reg => {
            console.log('SW Registered successfully:', reg);
            
            // Listen for messages from the SW
            navigator.serviceWorker.addEventListener('message', (event) => {
              console.log('Message from SW:', event.data);
              handleLoadingEvent(event);
            });
          })
          .catch(err => console.error('SW Registration Failed:', err));
      });
    }

    messageBtn.addEventListener('click', () => {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({
          type: 'myCustomEventType',
          payload: { data: 'some important data' }
        });
      } else {
        console.warn("No active SW controller found.");
      }
    });

    Array.from(downloadBtns).forEach(btn => {
      btn.addEventListener("click", async () => {
        if (isDownloading) return;

        if (!navigator.serviceWorker.controller) {
          statusText.innerText = "Error: Service Worker not ready. Please reload.";
          return;
        }

        isDownloading = true;
        progressBar.value = 0;
        statusText.innerText = "Starting download...";

        const fileName = btn.getAttribute('file');

        const iframe = document.createElement("iframe");
        iframe.style.display = "none";
        iframe.src = window[fileName];
        iframe.id = 'downloadFrame';
        document.body.appendChild(iframe);
      });
    });

    function enableDownload() {
      if (navigator.serviceWorker.controller) {
        Array.from(downloadBtns).forEach(btn => {
          btn.disabled = false;
          btn.innerText = "Start Download";
        });
      }
    }

    function handleLoadingEvent(event) {
      let frame = document.getElementById('downloadFrame');
      if (frame) {
        document.body.removeChild(frame);
        frame = null;
      }

      if (event.data.type === "DOWNLOAD_PROGRESS") {
        const { loaded, total } = event.data;
        const progress = Math.floor((loaded / total) * 100);

        progressBar.value = progress;
        statusText.innerText = `Downloading... ${progress}%`;
        return;
      }

      if (event.data.type === "DOWNLOAD_COMPLETE") {
        statusText.innerText = "Download complete!";
        isDownloading = false;
        return;
      }
    }
  </script>
</body>

</html>