<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Large File Download</title>

  <style>
    progress {
      width: 320px;
      height: 22px;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <h1>Large File Download</h1>

  <button id="download" file="file1Url" disabled>Loading Downloader...</button>
  <button id="download" file="file2Url" disabled>Loading Downloader...</button>

  <br><br>
  <progress id="progressBar" value="0" max="100"></progress>
  <p id="status"></p>

  <button id="messageBtn">Message Btn</button>

  <script>
    const messageBtn = document.getElementById("messageBtn");
    const downloadBtns = document.querySelectorAll("#download");
    const progressBar = document.getElementById("progressBar");
    const statusText = document.getElementById("status");

    window.file1Url = "http://localhost:3000/images/test.mp4";
    window.file2Url = "http://localhost:3000/images/stream-folder";
    let isDownloading = false;

    navigator.serviceWorker.addEventListener("message", (event) => {
      handleLoadingEvent(event);
    });

    function enableDownload() {
      if (navigator.serviceWorker.controller) {
        Array.from(downloadBtns).forEach(btn => {
          btn.disabled = false;
          btn.innerText = "Start Download";
        })
      }
    }

    enableDownload();


    navigator.serviceWorker.register('/sw.js').then((e) => {
      if (!navigator.serviceWorker.controller) window.location.reload();
    });

    messageBtn.addEventListener('click', () => {
      navigator.serviceWorker.controller.postMessage({
        type: 'myCustomEventType',
        payload: { data: 'some important data' }
      });
    })

    Array.from(downloadBtns).forEach(btn => {
      btn.addEventListener("click", async () => {
        if (isDownloading) return;

        if (!navigator.serviceWorker.controller) {
          statusText.innerText = "Error: Service Worker not ready. Please reload.";
          return;
        }

        isDownloading = true;
        progressBar.value = 0;
        statusText.innerText = "Starting download...";

        const fileName = btn.getAttribute('file');

        const iframe = document.createElement("iframe");
        iframe.style.display = "none";
        iframe.src = this[fileName];
        iframe.id = 'downloadFrame'
        document.body.appendChild(iframe);
      });
    })



    function handleLoadingEvent(event) {
      let frame = document.getElementById('downloadFrame');
      if (frame) {
        document.body.removeChild(frame);
        frame = null;
      }


      if (event.data.type === "DOWNLOAD_PROGRESS") {
        const { loaded, total } = event.data;
        const progress = Math.floor((loaded / total) * 100);

        progressBar.value = progress;
        statusText.innerText = `Downloading... ${progress}%`;
        return;
      }

      if (event.data.type === "DOWNLOAD_COMPLETE") {
        setTimeout(() => {
          statusText.innerText = "Download complete!";
          isDownloading = false;
        }, 1000);
        return;
      }
    }
  </script>
</body>

</html>