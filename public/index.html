<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Large File Download</title>

  <style>
    progress {
      width: 320px;
      height: 22px;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <h1>Large File Download</h1>

  <button id="downloadBtn" disabled>Loading Downloader...</button>
  <br><br>
  <progress id="progressBar" value="0" max="100"></progress>
  <p id="status"></p>

  <script>
    const downloadBtn = document.getElementById("downloadBtn");
    const progressBar = document.getElementById("progressBar");
    const statusText = document.getElementById("status");

    const fileUrl = "http://localhost:3000/images/Fotos-Copia.rar";
    let isDownloading = false;

    navigator.serviceWorker.addEventListener("message", (event) => {
      handleLoadingEvent(event);
    });

    function enableDownload() {
      if (navigator.serviceWorker.controller) {
        downloadBtn.disabled = false;
        downloadBtn.innerText = "Start Download";
      }
    }

    enableDownload();


    navigator.serviceWorker.register('/sw.js').then((e) => {
      if (!navigator.serviceWorker.controller) window.location.reload();
    });

    downloadBtn.addEventListener("click", async () => {
      if (isDownloading) return;

      if (!navigator.serviceWorker.controller) {
        statusText.innerText = "Error: Service Worker not ready. Please reload.";
        return;
      }

      isDownloading = true;
      progressBar.value = 0;
      statusText.innerText = "Starting download...";

      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = fileUrl;
      document.body.appendChild(iframe);
    });

    function handleLoadingEvent(event) {
      if (event.data.type === "DOWNLOAD_PROGRESS") {
        const { loaded, total } = event.data;
        const progress = Math.floor((loaded / total) * 100);

        progressBar.value = progress;
        statusText.innerText = `Downloading... ${progress}%`;

      } else if (event.data.type === "DOWNLOAD_COMPLETE") {
        setTimeout(() => {
          statusText.innerText = "Download complete!";
          isDownloading = false;
        }, 1000)
      }
    }
  </script>
</body>

</html>